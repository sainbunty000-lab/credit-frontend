<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI Underwriting Suite</title>
<style>
body{font-family:Arial;background:#0b1629;color:white;text-align:center;padding:40px}
.card{background:#16233d;padding:20px;border-radius:8px;margin:auto;max-width:600px}
button{padding:10px 20px;background:#00bcd4;border:none;color:white;border-radius:6px}
</style>
</head>
<body>

<h2>AI Underwriting Engine</h2>

<div class="card">
<input type="file" id="bs"><br><br>
<input type="file" id="pl"><br><br>
<input type="file" id="bank"><br><br>
<button onclick="runAnalysis()">Run Analysis</button>
<div id="result"></div>
</div>

<script>
const API_URL = "https://credit-backend-yh78.onrender.com";

async function wakeBackend(){
    try{
        await fetch(API_URL + "/health");
    }catch(e){}
}

async function safeFetch(url, options, retries=3){
    try{
        return await fetch(url, options);
    }catch(e){
        if(retries>0){
            await new Promise(r=>setTimeout(r,5000));
            return safeFetch(url, options, retries-1);
        }
        throw e;
    }
}

async function runAnalysis(){

    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = "Waking server...";

    await wakeBackend();

    resultDiv.innerHTML = "Running analysis...";

    const fd = new FormData();
    fd.append("bs_file", document.getElementById("bs").files[0]);
    fd.append("pl_file", document.getElementById("pl").files[0]);
    fd.append("bank_file", document.getElementById("bank").files[0]);

    try{
        const res = await safeFetch(API_URL + "/analyze", {
            method:"POST",
            body:fd
        });

        const data = await res.json();

        resultDiv.innerHTML = `
        <hr>
        Case ID: ${data.Case_ID}<br>
        Bank Turnover: ₹${data.Bank_Turnover}<br>
        WC Limit: ₹${data.Working_Capital_Limit}<br>
        Agri Limit: ₹${data.Agri_Limit}<br>
        Risk Score: ${data.Risk_Score}<br>
        Decision: ${data.Decision}<br>
        Confidence: ${data.Parsing_Confidence}%<br>
        Explanation: ${data.AI_Explanation}
        `;
    }catch(e){
        resultDiv.innerHTML = "Server unreachable. Try again in 30 seconds.";
    }
}
</script>

</body>
</html>
