<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Agri / WC Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    margin:0;
    font-family:Segoe UI;
    background:#0f172a;
    color:white;
}
header{
    background:#1e40af;
    padding:20px;
    text-align:center;
    font-size:22px;
    font-weight:bold;
}
.container{
    max-width:1000px;
    margin:auto;
    padding:20px;
}
.card{
    background:#1e293b;
    padding:20px;
    border-radius:12px;
    margin-bottom:20px;
}
input{
    width:100%;
    padding:10px;
    margin:10px 0;
    border-radius:6px;
    border:none;
}
button{
    background:#22c55e;
    color:white;
    border:none;
    padding:12px;
    border-radius:6px;
    font-weight:bold;
    cursor:pointer;
}
button:hover{
    background:#16a34a;
}
.loader{
    display:none;
    margin:auto;
    border:6px solid #334155;
    border-top:6px solid #22c55e;
    border-radius:50%;
    width:60px;
    height:60px;
    animation:spin 1s linear infinite;
}
@keyframes spin{
    100%{transform:rotate(360deg)}
}
canvas{
    background:#0f172a;
    border-radius:10px;
    padding:10px;
}
.low{color:#22c55e}
.moderate{color:#facc15}
.high{color:#ef4444}
</style>
</head>

<body>

<header>Agri / WC Calculator</header>

<div class="container">

<div class="card">
<h3>Upload Financial Files</h3>
<input type="file" id="bs">
<input type="file" id="pl">
<button onclick="runAnalysis()">Run Analysis</button>
</div>

<div class="loader" id="loader"></div>

<div id="result" style="display:none">

<div class="card">
<h3>Risk Assessment</h3>
<h2 id="riskScore"></h2>
<h3 id="riskClass"></h3>
</div>

<div class="card">
<h3>Financial Metrics Chart</h3>
<canvas id="barChart"></canvas>
</div>

<div class="card">
<h3>Liquidity vs Repayment Radar</h3>
<canvas id="radarChart"></canvas>
</div>

<div class="card">
<h3>AI Credit Memo</h3>
<p id="memo"></p>
</div>

</div>

</div>

<script>

const API_URL = "https://credit-backend-production-6a6d.up.railway.app";

let chartsCreated = false;

async function runAnalysis(){

    const bs = document.getElementById("bs").files[0];
    const pl = document.getElementById("pl").files[0];

    if(!bs || !pl){
        alert("Balance Sheet and P&L required");
        return;
    }

    const fd = new FormData();
    fd.append("bs_file", bs);
    fd.append("pl_file", pl);

    document.getElementById("loader").style.display="block";

    try{
        const response = await fetch(API_URL + "/analyze",{
            method:"POST",
            body:fd
        });

        const data = await response.json();

        document.getElementById("loader").style.display="none";
        document.getElementById("result").style.display="block";

        displayData(data);

    }catch(error){
        alert("Backend not reachable.");
        document.getElementById("loader").style.display="none";
    }
}

function displayData(data){

    const m = data.Metrics;

    document.getElementById("riskScore").innerText = 
        "Risk Score: " + data.Risk_Score;

    document.getElementById("riskClass").innerText = data.Risk_Class;
    document.getElementById("riskClass").className =
        data.Risk_Class==="Low Risk"?"low":
        data.Risk_Class==="Moderate Risk"?"moderate":"high";

    document.getElementById("memo").innerText = data.AI_Narrative;

    new Chart(document.getElementById("barChart"),{
        type:"bar",
        data:{
            labels:["NWC","MPBF","WC Limit","Agri Limit"],
            datasets:[{
                data:[
                    m.NWC,
                    m.MPBF,
                    m.WC_Limit,
                    m.Agri_Limit
                ],
                backgroundColor:["#3b82f6","#22c55e","#f59e0b","#ef4444"]
            }]
        },
        options:{plugins:{legend:{display:false}}}
    });

    new Chart(document.getElementById("radarChart"),{
        type:"radar",
        data:{
            labels:["Liquidity","Profitability","Leverage","Repayment"],
            datasets:[{
                data:[
                    m.Current_Ratio,
                    m.EBITDA/100000,
                    m.NWC/100000,
                    m.DSCR
                ],
                backgroundColor:"rgba(59,130,246,0.4)",
                borderColor:"#3b82f6"
            }]
        }
    });
}

</script>

</body>
</html>
