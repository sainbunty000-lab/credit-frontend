<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Underwriting Intelligence Suite</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00bcd4">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0b1629;color:white}
.container{max-width:1200px;margin:auto;padding:30px}
.nav{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.nav button{padding:10px 18px;border:none;border-radius:6px;background:#1f2f4f;color:white;cursor:pointer}
.nav button.active{background:#00bcd4}
.slide{display:none}
.slide.active{display:block}
.card{background:#16233d;padding:20px;border-radius:10px;margin-bottom:20px}
button.primary{background:#00bcd4;border:none;padding:10px 20px;border-radius:6px;color:white;cursor:pointer}
.result-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}
.box{background:#0f1e36;padding:15px;border-radius:8px}
.green{color:#00e676}
.orange{color:orange}
.red{color:#ff5252}
.progress{height:8px;background:#333;border-radius:4px;overflow:hidden;margin-top:10px}
.progress-bar{height:8px;background:#00e676;width:0%;transition:1s}
ul{padding-left:20px}
</style>
</head>

<body>
<div class="container">

<h1>Enterprise AI Underwriting</h1>

<div class="nav">
<button onclick="goSlide(1)" class="active">1 Upload</button>
<button onclick="goSlide(2)">2 Financial</button>
<button onclick="goSlide(3)">3 Banking</button>
<button onclick="goSlide(4)">4 Eligibility</button>
<button onclick="goSlide(5)">5 CAM</button>
</div>

<!-- SLIDE 1 -->
<div id="slide1" class="slide active card">
<h3>Upload Documents</h3>
<input type="file" id="bs"><br><br>
<input type="file" id="pl"><br><br>
<input type="file" id="bank"><br><br>
<button class="primary" onclick="runAnalysis()">Run Analysis</button>
</div>

<!-- SLIDE 2 -->
<div id="slide2" class="slide card">
<h3>Financial Ratio Analysis</h3>
<div id="financialData" class="result-grid"></div>
<canvas id="ratioChart"></canvas>
</div>

<!-- SLIDE 3 -->
<div id="slide3" class="slide card">
<h3>Banking & Fraud Analysis</h3>
<div id="bankingData"></div>
<h4>Fraud Flags</h4>
<ul id="fraudList"></ul>
</div>

<!-- SLIDE 4 -->
<div id="slide4" class="slide card">
<h3>Eligibility Engines</h3>
<div id="eligibilityData" class="result-grid"></div>
</div>

<!-- SLIDE 5 -->
<div id="slide5" class="slide card">
<h3>Final CAM Report</h3>
<div id="camReport"></div>
<button class="primary" onclick="downloadPDF()">Download CAM PDF</button>
</div>

</div>

<script>

const API_URL="https://credit-backend-yh78.onrender.com";
let globalData=null;

function goSlide(n){
document.querySelectorAll(".slide").forEach(s=>s.classList.remove("active"));
document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
document.getElementById("slide"+n).classList.add("active");
document.querySelectorAll(".nav button")[n-1].classList.add("active");
}

function riskColor(score){
if(score>=75) return "green";
if(score>=50) return "orange";
return "red";
}

function formatCurrency(num){
return "â‚¹"+Number(num).toLocaleString("en-IN");
}

async function runAnalysis(){

let bs=document.getElementById("bs").files[0];
let pl=document.getElementById("pl").files[0];
let bank=document.getElementById("bank").files[0];

if(!bs||!pl||!bank){
alert("Upload all 3 documents");
return;
}

let fd=new FormData();
fd.append("bs_file",bs);
fd.append("pl_file",pl);
fd.append("bank_file",bank);

let res=await fetch(API_URL+"/analyze",{method:"POST",body:fd});
let data=await res.json();

globalData=data;

renderFinancial(data);
renderBanking(data);
renderEligibility(data);
renderCAM(data);

goSlide(2);
}

function renderFinancial(data){

document.getElementById("financialData").innerHTML=`
<div class="box"><b>Profit Margin</b><br>${data.Profit_Margin}%</div>
<div class="box"><b>Current Ratio</b><br>${data.Current_Ratio}</div>
<div class="box"><b>Bank Turnover</b><br>${formatCurrency(data.Bank_Turnover)}</div>
`;

new Chart(document.getElementById("ratioChart"),{
type:"bar",
data:{
labels:["Profit Margin","Current Ratio"],
datasets:[{
data:[data.Profit_Margin,data.Current_Ratio],
backgroundColor:["#00bcd4","#4caf50"]
}]
}
});
}

function renderBanking(data){

document.getElementById("bankingData").innerHTML=`
<p><b>Mismatch %:</b> ${data["Mismatch_%"]}%</p>
<p><b>Risk Score:</b> <span class="${riskColor(data.Risk_Score)}">${data.Risk_Score}</span></p>
<p><b>Decision:</b> ${data.Decision}</p>
`;

let frauds=[];
if(data["Mismatch_%"]>30) frauds.push("High Turnover Mismatch");
if(data.Current_Ratio<0.8) frauds.push("Liquidity Stress");
if(frauds.length===0) frauds.push("No major red flags");

document.getElementById("fraudList").innerHTML=
frauds.map(f=>`<li>${f}</li>`).join("");
}

function renderEligibility(data){

let agriLimit=(data.Profit_Margin*1000)/0.14; // placeholder logic
document.getElementById("eligibilityData").innerHTML=`
<div class="box"><b>Agriculture Limit</b><br>${formatCurrency(agriLimit)}</div>
<div class="box"><b>Working Capital Limit</b><br>${formatCurrency(data.Working_Capital_Limit)}</div>
`;
}

function renderCAM(data){

let explanation="";
if(data.Risk_Score>=75) explanation="Strong financial profile.";
else if(data.Risk_Score>=50) explanation="Moderate risk profile.";
else explanation="High risk profile.";

document.getElementById("camReport").innerHTML=`
<p><b>Case ID:</b> ${data.Case_ID}</p>
<p><b>Decision:</b> ${data.Decision}</p>
<p><b>Risk Score:</b> ${data.Risk_Score}</p>
<p><b>AI Explanation:</b> ${explanation}</p>
`;
}

function downloadPDF(){

const { jsPDF } = window.jspdf;
let doc=new jsPDF();
doc.text("Credit Appraisal Memorandum",20,20);
doc.text("Case ID: "+globalData.Case_ID,20,40);
doc.text("Decision: "+globalData.Decision,20,50);
doc.text("Risk Score: "+globalData.Risk_Score,20,60);
doc.save("CAM_Report.pdf");
}

if("serviceWorker" in navigator){
navigator.serviceWorker.register("sw.js");
}

</script>
</body>
</html>
