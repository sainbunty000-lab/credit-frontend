<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agri / WC Calculator</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>

:root{
--bg:#0b1120;
--card:#111827;
--text:#ffffff;
--accent:#22c55e;
}

body.light{
--bg:#f1f5f9;
--card:#ffffff;
--text:#000000;
--accent:#2563eb;
}

body{
margin:0;
font-family:'Segoe UI';
background:var(--bg);
color:var(--text);
display:flex;
transition:0.3s;
}

.sidebar{
width:260px;
height:100vh;
background:linear-gradient(180deg,#0f172a,#111827);
padding:20px;
position:fixed;
}

.sidebar h2{
color:var(--accent);
}

.btn{
width:100%;
padding:10px;
margin:8px 0;
border:none;
border-radius:8px;
cursor:pointer;
font-weight:600;
background:#1e293b;
color:white;
}

.btn:hover{
background:var(--accent);
color:black;
}

.main{
margin-left:280px;
padding:30px;
width:100%;
}

.card{
background:var(--card);
padding:20px;
border-radius:12px;
margin-bottom:20px;
box-shadow:0 0 15px rgba(0,0,0,0.3);
}

input{
width:100%;
padding:10px;
margin-bottom:10px;
border:none;
border-radius:6px;
background:#1e293b;
color:white;
}

.slide{display:none;}

.kpi-grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:15px;
}

.kpi{
padding:20px;
border-radius:10px;
text-align:center;
font-weight:bold;
}

.green{background:#16a34a;}
.blue{background:#2563eb;}
.orange{background:#f59e0b;}
.red{background:#dc2626;}

</style>
</head>

<body>

<div class="sidebar">
<h2>Agri / WC Calculator</h2>

<button class="btn" onclick="showSlide('wc')">Working Capital</button>
<button class="btn" onclick="showSlide('tl')">Term Loan</button>
<button class="btn" onclick="showSlide('agri')">Agriculture</button>
<button class="btn" onclick="showSlide('bank')">Banking</button>
<button class="btn" onclick="showSlide('dashboard')">Dashboard</button>

<button class="btn" onclick="toggleTheme()">Dark/Light</button>
<button class="btn" onclick="downloadCAM()">Download CAM</button>
</div>

<div class="main">

<!-- WC -->
<div id="wc" class="slide card">
<h3>Working Capital</h3>
<input id="turnover" placeholder="Turnover">
<input id="inventory" placeholder="Inventory">
<input id="debtors" placeholder="Debtors">
<input id="creditors" placeholder="Creditors">
<button class="btn" onclick="runAnalysis()">Calculate</button>
</div>

<!-- TL -->
<div id="tl" class="slide card">
<h3>Term Loan</h3>
<input id="net_profit" placeholder="Net Profit">
<input id="depreciation" placeholder="Depreciation">
<input id="monthly_emi" placeholder="Monthly EMI">
<button class="btn" onclick="runAnalysis()">Calculate</button>
</div>

<!-- AGRI -->
<div id="agri" class="slide card">
<h3>Agriculture</h3>
<input id="tax_paid" placeholder="Tax Paid">
<input id="loan_required" placeholder="Loan Required">
<input id="undoc" placeholder="Undocumented Income">
<button class="btn" onclick="runAnalysis()">Calculate</button>
</div>

<!-- BANK -->
<div id="bank" class="slide card">
<h3>Banking PERFIOS</h3>
<input type="file" id="bankFile">
<button class="btn" onclick="uploadBank()">Analyze Banking</button>
<div id="bankResult"></div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="slide">

<div class="kpi-grid">
<div id="wc_kpi" class="kpi green">WC ₹0</div>
<div id="tl_kpi" class="kpi blue">TL ₹0</div>
<div id="agri_kpi" class="kpi orange">Agri ₹0</div>
<div id="risk_kpi" class="kpi red">Risk 0</div>
</div>

<div class="card">
<canvas id="chart"></canvas>
</div>

<div class="card">
<label>Stress Slider (Agri %) </label>
<input type="range" min="10" max="25" value="14" id="stress">
</div>

</div>

</div>

<script>

const API="https://credit-backend-production-6a6d.up.railway.app/analyze";
const BANK="https://credit-backend-production-6a6d.up.railway.app/banking";

let chart;
let dataStore={};
let hygieneScore=80;

function showSlide(id){
document.querySelectorAll('.slide').forEach(s=>s.style.display="none");
document.getElementById(id).style.display="block";
}

showSlide("wc");

function toggleTheme(){
document.body.classList.toggle("light");
}

async function runAnalysis(){

let payload={
turnover:+turnover.value||0,
inventory:+inventory.value||0,
debtors:+debtors.value||0,
creditors:+creditors.value||0,
net_profit:+net_profit.value||0,
depreciation:+depreciation.value||0,
tax_paid:+tax_paid.value||0,
monthly_emi:+monthly_emi.value||0,
loan_required:+loan_required.value||0,
undocumented_income:+undoc.value||0,
hygiene_score:hygieneScore
};

let res=await fetch(API,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(payload)
});

dataStore=await res.json();

updateDashboard();
showSlide("dashboard");
}

function updateDashboard(){

wc_kpi.innerHTML="WC ₹"+dataStore.wc;
tl_kpi.innerHTML="TL ₹"+dataStore.tl_eligible;
agri_kpi.innerHTML="Agri ₹"+dataStore.agri_eligible;
risk_kpi.innerHTML="Risk "+dataStore.risk_score+" ("+dataStore.rating+")";

if(chart) chart.destroy();

chart=new Chart(document.getElementById("chart"),{
type:'bar',
data:{
labels:["WC","TL","Agri"],
datasets:[{
data:[dataStore.wc,dataStore.tl_eligible,dataStore.agri_eligible],
backgroundColor:["#16a34a","#2563eb","#f59e0b"]
}]
},
options:{animation:{duration:1000}}
});

}

async function uploadBank(){

const file=document.getElementById("bankFile").files[0];
let form=new FormData();
form.append("file",file);

let res=await fetch(BANK,{method:"POST",body:form});
let data=await res.json();

hygieneScore=data.hygiene_score;

bankResult.innerHTML=
"Credit: ₹"+data.total_credit+
"<br>Debit: ₹"+data.total_debit+
"<br>Bounce: "+data.bounce_count+
"<br>Hygiene Score: "+data.hygiene_score;
}

function downloadCAM(){

const { jsPDF } = window.jspdf;
let doc=new jsPDF();

doc.text("CREDIT APPRAISAL MEMO",20,20);
doc.text("Working Capital: ₹"+dataStore.wc,20,40);
doc.text("Term Loan: ₹"+dataStore.tl_eligible,20,50);
doc.text("Agriculture: ₹"+dataStore.agri_eligible,20,60);
doc.text("Risk Score: "+dataStore.risk_score+" Rating:"+dataStore.rating,20,70);
doc.text("Final Recommended Limit: ₹"+dataStore.final_limit,20,80);

doc.save("CAM_Report.pdf");
}

</script>

</body>
</html>
