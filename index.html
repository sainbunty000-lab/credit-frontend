<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agri / WC Calculator</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
--bg:#0b1120;
--card:rgba(255,255,255,0.08);
--text:#fff;
--accent:#22c55e;
}
body.light{
--bg:#f1f5f9;
--card:#ffffff;
--text:#000;
--accent:#2563eb;
}
body{
margin:0;
font-family:'Segoe UI';
background:var(--bg);
color:var(--text);
display:flex;
transition:0.3s;
}
.sidebar{
width:260px;
height:100vh;
background:linear-gradient(180deg,#0f172a,#111827);
padding:20px;
position:fixed;
backdrop-filter:blur(10px);
}
.sidebar h2{color:var(--accent);}
.btn{
width:100%;
padding:10px;
margin:6px 0;
border:none;
border-radius:8px;
cursor:pointer;
font-weight:600;
background:#1e293b;
color:white;
}
.btn:hover{background:var(--accent);color:black;}
.main{margin-left:280px;padding:25px;width:100%;}
.card{
background:var(--card);
padding:20px;
border-radius:12px;
margin-bottom:20px;
backdrop-filter:blur(12px);
}
input{
width:100%;
padding:10px;
margin-bottom:10px;
border:none;
border-radius:6px;
background:#1e293b;
color:white;
}
.slide{display:none;}
.kpi-grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:15px;
}
.kpi{
padding:20px;
border-radius:10px;
text-align:center;
font-weight:bold;
}
.green{background:#16a34a;}
.blue{background:#2563eb;}
.orange{background:#f59e0b;}
.red{background:#dc2626;}
</style>
</head>

<body>

<div class="sidebar">
<h2>Agri / WC Calculator</h2>

<button class="btn" onclick="showSlide('wc')">Working Capital</button>
<button class="btn" onclick="showSlide('tl')">Term Loan</button>
<button class="btn" onclick="showSlide('agri')">Agriculture</button>
<button class="btn" onclick="showSlide('bank')">Banking</button>
<button class="btn" onclick="showSlide('dashboard')">Dashboard</button>

<button class="btn" onclick="toggleMode()">Mode: <span id="modeText">Backend</span></button>
<button class="btn" onclick="toggleTheme()">Dark/Light</button>
<button class="btn" onclick="downloadCAM()">Download CAM</button>
</div>

<div class="main">

<!-- WC -->
<div id="wc" class="slide card">
<h3>Working Capital</h3>
<input id="turnover" placeholder="Turnover">
<input id="inventory" placeholder="Inventory">
<input id="debtors" placeholder="Debtors">
<input id="creditors" placeholder="Creditors">
<button class="btn" onclick="calculateWC()">Calculate WC</button>
<div id="wcResult"></div>
</div>

<!-- TL -->
<div id="tl" class="slide card">
<h3>Term Loan</h3>
<input id="net_profit" placeholder="Net Profit">
<input id="depreciation" placeholder="Depreciation">
<input id="monthly_emi" placeholder="Monthly EMI">
<button class="btn" onclick="calculateTL()">Calculate TL</button>
<div id="tlResult"></div>
</div>

<!-- AGRI -->
<div id="agri" class="slide card">
<h3>Agriculture</h3>
<input id="tax_paid" placeholder="Tax Paid">
<input id="loan_required" placeholder="Loan Required">
<input id="undoc" placeholder="Undocumented Income">
<label>Stress %</label>
<input type="range" min="10" max="25" value="14" id="stress">
<button class="btn" onclick="calculateAgri()">Calculate Agri</button>
<div id="agriResult"></div>
</div>

<!-- BANK -->
<div id="bank" class="slide card">
<h3>Banking PERFIOS</h3>
<input type="file" id="bankFile">
<button class="btn" onclick="uploadBank()">Analyze Banking</button>
<div id="bankResult"></div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="slide">
<div class="kpi-grid">
<div id="wc_kpi" class="kpi green">WC ₹0</div>
<div id="tl_kpi" class="kpi blue">TL ₹0</div>
<div id="agri_kpi" class="kpi orange">Agri ₹0</div>
<div id="risk_kpi" class="kpi red">Risk 0</div>
</div>
<div class="card"><canvas id="chart"></canvas></div>
</div>

</div>

<script>

const API="https://credit-backend-production-6a6d.up.railway.app/analyze";
const BANK="https://credit-backend-production-6a6d.up.railway.app/banking";

let mode="backend";
let hygieneScore=80;
let results={wc:0,tl:0,agri:0,risk:0,rating:"B",final:0};

function showSlide(id){
document.querySelectorAll('.slide').forEach(s=>s.style.display="none");
document.getElementById(id).style.display="block";
}
showSlide("wc");

function toggleTheme(){document.body.classList.toggle("light");}

function toggleMode(){
mode = mode==="backend"?"local":"backend";
modeText.innerText = mode==="backend"?"Backend":"Local";
}

function safe(v){return parseFloat(v)||0;}

async function calculateWC(){
let turnover=safe(turnover.value);
let inv=safe(inventory.value);
let deb=safe(debtors.value);
let cred=safe(creditors.value);

let wc_turnover=turnover*0.20;
let mpbf=0.75*((inv+deb)-cred);
results.wc=Math.min(wc_turnover,mpbf);

wcResult.innerHTML="Final WC ₹"+results.wc;
updateDashboard();
}

async function calculateTL(){
let profit=safe(net_profit.value);
let dep=safe(depreciation.value);
let emi=safe(monthly_emi.value);

let accrual=profit+dep;
let annual=emi*12;
let dscr=annual>0?accrual/annual:0;
let surplus=accrual-annual;
results.tl=surplus>0?surplus*6:0;

tlResult.innerHTML="TL Eligible ₹"+results.tl+" DSCR:"+dscr.toFixed(2);
updateDashboard();
}

async function calculateAgri(){
let profit=safe(net_profit.value);
let dep=safe(depreciation.value);
let tax=safe(tax_paid.value);
let emi=safe(monthly_emi.value);
let loan=safe(loan_required.value);
let und=safe(undoc.value);
let stress=safe(stress.value);

let nca=profit+dep-tax;
let scaling=loan>3000000?0.70:0.60;
let scaled=nca*scaling;
let monthly=(scaled/12)-emi+((und*0.42)/12);
results.agri=monthly>0?monthly/(stress/100):0;

agriResult.innerHTML="Agri Eligible ₹"+results.agri;
updateDashboard();
}

async function uploadBank(){
const file=document.getElementById("bankFile").files[0];
let form=new FormData();
form.append("file",file);
let res=await fetch(BANK,{method:"POST",body:form});
let data=await res.json();
hygieneScore=data.hygiene_score;
bankResult.innerHTML="Hygiene:"+hygieneScore;
}

function updateDashboard(){

let riskScore = (results.wc>0?20:0)+(results.tl>0?20:0)+(results.agri>0?20:0)+(hygieneScore*0.4);
riskScore=Math.min(100,Math.round(riskScore));
let rating=riskScore>85?"AAA":riskScore>75?"AA":riskScore>65?"A":riskScore>55?"BBB":"BB";

wc_kpi.innerHTML="WC ₹"+results.wc;
tl_kpi.innerHTML="TL ₹"+results.tl;
agri_kpi.innerHTML="Agri ₹"+results.agri;
risk_kpi.innerHTML="Risk "+riskScore+" "+rating;

if(window.chart) chart.destroy();
chart=new Chart(document.getElementById("chart"),{
type:"bar",
data:{
labels:["WC","TL","Agri"],
datasets:[{data:[results.wc,results.tl,results.agri],
backgroundColor:["#16a34a","#2563eb","#f59e0b"]}]
},
options:{animation:{duration:1000}}
});

results.risk=riskScore;
results.rating=rating;
results.final=Math.max(results.wc,results.tl,results.agri);
}

function downloadCAM(){
const { jsPDF } = window.jspdf;
let doc=new jsPDF();
doc.text("CREDIT APPRAISAL MEMO",20,20);
doc.text("WC ₹"+results.wc,20,40);
doc.text("TL ₹"+results.tl,20,50);
doc.text("Agri ₹"+results.agri,20,60);
doc.text("Risk "+results.risk+" Rating:"+results.rating,20,70);
doc.text("Final Limit ₹"+results.final,20,80);
doc.save("CAM_Report.pdf");
}

</script>

</body>
</html>
