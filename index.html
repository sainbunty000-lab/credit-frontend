<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agri / WC Calculator</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin:0;
    font-family: Arial, sans-serif;
    background:#0f172a;
    color:white;
}
header {
    padding:20px;
    text-align:center;
    font-size:24px;
    font-weight:bold;
    background:linear-gradient(90deg,#0ea5e9,#22c55e);
}
.container {
    padding:20px;
    max-width:900px;
    margin:auto;
}
.card {
    background:#1e293b;
    padding:20px;
    border-radius:12px;
    margin-bottom:20px;
}
input[type=file] {
    width:100%;
    margin:10px 0;
}
button {
    width:100%;
    padding:12px;
    background:#22c55e;
    border:none;
    color:white;
    font-weight:bold;
    border-radius:8px;
    cursor:pointer;
}
button:hover {
    opacity:0.9;
}
.loader {
    display:none;
    text-align:center;
    margin-top:15px;
}
.result-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:15px;
}
.metric {
    background:#334155;
    padding:15px;
    border-radius:10px;
}
canvas {
    margin-top:20px;
    background:white;
    border-radius:10px;
}
.memo {
    white-space:pre-line;
    background:#111827;
    padding:15px;
    border-radius:10px;
}
</style>
</head>

<body>

<header>üè¶ Agri / WC Calculator</header>

<div class="container">

<div class="card">
<h3>Upload Financial Documents</h3>

<label>Balance Sheet (Mandatory)</label>
<input type="file" id="bsFile" required>

<label>Profit & Loss (Mandatory)</label>
<input type="file" id="plFile" required>

<label>Bank Statement (Optional)</label>
<input type="file" id="bankFile">

    <div id="resultsSection" style="display:none; margin-top:20px;">
    <h3>Financial Summary</h3>
    <p>Sales: <span id="sales"></span></p>
    <p>NWC: <span id="nwc"></span></p>
    <p>Current Ratio: <span id="cr"></span></p>
    <p>MPBF: <span id="mpbf"></span></p>
    <p>WC Limit: <span id="wcLimit"></span></p>
    <p>Agri Limit: <span id="agriLimit"></span></p>
    <p>Risk Score: <span id="riskScore"></span></p>
    <p>Decision: <span id="decision"></span></p>
    </div>
    
<button onclick="runAnalysis()">Run Analysis</button>

<div class="loader" id="loader">Processing Financial Data...</div>
</div>

<div class="card" id="results" style="display:none;">

<h3>Financial Summary</h3>

<div class="result-grid" id="metrics"></div>

<canvas id="financeChart"></canvas>

<h3>AI Credit Memo</h3>
<div class="memo" id="memo"></div>

</div>

</div>

<script>

const API_URL = "https://credit-backend-production-6a6d.up.railway.app";

let chartInstance = null;

async function runAnalysis() {
    const bsFile = document.getElementById("bsFile").files[0];
    const plFile = document.getElementById("plFile").files[0];
    const bankFile = document.getElementById("bankFile").files[0];

    if (!bsFile || !plFile) {
        alert("Balance Sheet and P&L are mandatory");
        return;
    }

    const formData = new FormData();
    formData.append("bs_file", bsFile);
    formData.append("pl_file", plFile);

    if (bankFile) {
        formData.append("bank_file", bankFile);
    }

    try {
        const response = await fetch(
            "https://credit-backend-production-6a6d.up.railway.app/analyze",
            {
                method: "POST",
                body: formData
            }
        );

        if (!response.ok) {
            const errorText = await response.text();
            console.error(errorText);
            alert("Server Error: " + errorText);
            return;
        }

        const data = await response.json();
        console.log(data);

        alert("document.getElementById("resultsSection").style.display = "block";

document.getElementById("sales").innerText = "‚Çπ " + data.Sales;
document.getElementById("nwc").innerText = "‚Çπ " + data.NWC;
document.getElementById("cr").innerText = data.Current_Ratio;
document.getElementById("mpbf").innerText = "‚Çπ " + data.MPBF;
document.getElementById("wcLimit").innerText = "‚Çπ " + data.Working_Capital_Limit;
document.getElementById("agriLimit").innerText = "‚Çπ " + data.Agri_Limit;
document.getElementById("riskScore").innerText = data.Risk_Score;
document.getElementById("decision").innerText = data.Decision;");
    } catch (error) {
        console.error(error);
        alert("Connection Failed");
    }
}

function displayResults(data) {

    const metricsDiv = document.getElementById("metrics");

    metricsDiv.innerHTML = `
        <div class="metric">Sales: ‚Çπ${data.Sales || 0}</div>
        <div class="metric">NWC: ‚Çπ${data.NWC || 0}</div>
        <div class="metric">Current Ratio: ${data.Current_Ratio || 0}</div>
        <div class="metric">MPBF: ‚Çπ${data.MPBF || 0}</div>
        <div class="metric">WC Limit: ‚Çπ${data.Working_Capital_Limit || 0}</div>
        <div class="metric">Agri Limit: ‚Çπ${data.Agri_Limit || 0}</div>
        <div class="metric">Risk Score: ${data.Risk_Score || 0}</div>
        <div class="metric">Decision: ${data.Decision || "N/A"}</div>
    `;

    document.getElementById("memo").innerText = data.Memo || "";

    renderChart(data);
}

function renderChart(data) {

    const ctx = document.getElementById("financeChart").getContext("2d");

    if (chartInstance) {
        chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Sales','MPBF','WC Limit','Agri Limit'],
            datasets: [{
                label: 'Financial Values',
                data: [
    data.Sales || 0,
    data.MPBF || 0,
    data.Working_Capital_Limit || 0,
    data.Agri_Limit || 0
],
                backgroundColor: [
                    '#0ea5e9',
                    '#f59e0b',
                    '#22c55e',
                    '#ef4444'
                ]
            }]
        },
        options: {
            responsive:true,
            plugins:{
                legend:{display:false}
            }
        }
    });
}

</script>

</body>
</html>
