<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Agri / WC Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    margin:0;
    font-family:Segoe UI;
    background:#0f172a;
    color:white;
}
header{
    background:linear-gradient(90deg,#1e40af,#2563eb);
    padding:20px;
    text-align:center;
    font-size:22px;
    font-weight:bold;
}
.container{
    max-width:1200px;
    margin:auto;
    padding:20px;
}
.card{
    background:#1e293b;
    padding:20px;
    border-radius:12px;
    margin-bottom:20px;
}
input{
    width:100%;
    padding:10px;
    margin:8px 0;
    border-radius:6px;
    border:none;
}
button{
    background:#22c55e;
    color:white;
    border:none;
    padding:12px;
    border-radius:6px;
    font-weight:bold;
    cursor:pointer;
}
button:hover{background:#16a34a}
.grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
    gap:20px;
}
.metric{
    background:#0f172a;
    padding:15px;
    border-radius:8px;
    text-align:center;
}
.low{color:#22c55e}
.moderate{color:#facc15}
.high{color:#ef4444}
.loader{
    display:none;
    margin:auto;
    border:6px solid #334155;
    border-top:6px solid #22c55e;
    border-radius:50%;
    width:60px;
    height:60px;
    animation:spin 1s linear infinite;
}
@keyframes spin{100%{transform:rotate(360deg)}}
canvas{background:#0f172a;border-radius:10px;padding:10px}
</style>
</head>

<body>

<header>Agri / WC Calculator â€“ Financial Analytics Dashboard</header>

<div class="container">

<div class="card">
<h3>Upload Financial Statements</h3>
<input type="file" id="bs">
<input type="file" id="pl">
<button onclick="runAnalysis()">Run Analysis</button>
</div>

<div class="loader" id="loader"></div>

<div id="dashboard" style="display:none">

<div class="grid">

<div class="metric">
<h4>Risk Score</h4>
<canvas id="riskGauge"></canvas>
<p id="riskClass"></p>
</div>

<div class="metric">
<h4>Liquidity Ratio</h4>
<h2 id="cr"></h2>
</div>

<div class="metric">
<h4>DSCR</h4>
<h2 id="dscr"></h2>
</div>

</div>

<div class="card">
<h3>Funding Eligibility Overview</h3>
<canvas id="fundingChart"></canvas>
</div>

<div class="card">
<h3>Financial Strength Radar</h3>
<canvas id="radarChart"></canvas>
</div>

<div class="card">
<h3>AI Credit Memo</h3>
<p id="memo"></p>
</div>

<div class="card">
<button onclick="downloadCAM()">Download CAM Report</button>
</div>

</div>

</div>

<script>

const API_URL = "https://YOUR-RAILWAY-DOMAIN.up.railway.app";

let result;

async function runAnalysis(){

    const bs = document.getElementById("bs").files[0];
    const pl = document.getElementById("pl").files[0];

    if(!bs || !pl){
        alert("Balance Sheet and P&L required");
        return;
    }

    const fd = new FormData();
    fd.append("bs_file", bs);
    fd.append("pl_file", pl);

    document.getElementById("loader").style.display="block";

    const res = await fetch(API_URL + "/analyze",{
        method:"POST",
        body:fd
    });

    result = await res.json();

    document.getElementById("loader").style.display="none";
    document.getElementById("dashboard").style.display="block";

    displayResults(result);
}

function displayResults(data){

    const m = data.Metrics;

    // Text Metrics
    document.getElementById("cr").innerText = m.Current_Ratio.toFixed(2);
    document.getElementById("dscr").innerText = m.DSCR.toFixed(2);
    document.getElementById("memo").innerText = data.AI_Narrative;

    document.getElementById("riskClass").innerText = data.Risk_Class;
    document.getElementById("riskClass").className =
        data.Risk_Class==="Low Risk"?"low":
        data.Risk_Class==="Moderate Risk"?"moderate":"high";

    // Risk Gauge (Doughnut)
    new Chart(document.getElementById("riskGauge"),{
        type:"doughnut",
        data:{
            labels:["Score","Remaining"],
            datasets:[{
                data:[data.Risk_Score,100-data.Risk_Score],
                backgroundColor:["#22c55e","#334155"]
            }]
        },
        options:{
            plugins:{legend:{display:false}},
            cutout:"70%"
        }
    });

    // Funding Chart
    new Chart(document.getElementById("fundingChart"),{
        type:"bar",
        data:{
            labels:["MPBF","WC Limit","Agri Limit","NWC"],
            datasets:[{
                data:[
                    m.MPBF,
                    m.WC_Limit,
                    m.Agri_Limit,
                    m.NWC
                ],
                backgroundColor:["#3b82f6","#22c55e","#f59e0b","#ef4444"]
            }]
        },
        options:{plugins:{legend:{display:false}}}
    });

    // Radar Chart
    new Chart(document.getElementById("radarChart"),{
        type:"radar",
        data:{
            labels:["Liquidity","Profitability","Leverage","Repayment"],
            datasets:[{
                data:[
                    m.Current_Ratio,
                    m.EBITDA/100000,
                    m.NWC/100000,
                    m.DSCR
                ],
                backgroundColor:"rgba(59,130,246,0.4)",
                borderColor:"#3b82f6"
            }]
        }
    });

}

function downloadCAM(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Agri / WC Calculator - Credit Appraisal Memo",20,20);
    doc.text(result.AI_Narrative,20,40,{maxWidth:170});
    doc.save("CAM_Report.pdf");
}

</script>

</body>
</html>
