<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Credit Underwriting Suite</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

<style>
body { margin:0; font-family:'Segoe UI'; background:#f4f6f9; }
header { background:#0a3d62; color:white; padding:18px; text-align:center; font-size:20px; font-weight:bold; }
.container { padding:20px; max-width:1100px; margin:auto; }
.card { background:white; padding:20px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
input, select { padding:8px; border:1px solid #ccc; border-radius:6px; width:100%; }
button { background:#0a3d62; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold; }
button:hover { background:#082c45; }
table { width:100%; border-collapse:collapse; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#0a3d62; color:white; }
.green { color:green; font-weight:bold; }
.orange { color:orange; font-weight:bold; }
.red { color:red; font-weight:bold; }
.loading { text-align:center; font-weight:bold; color:#0a3d62; }
hr { margin:15px 0; }
</style>
</head>

<body>

<header>
Credit Underwriting Intelligence Suite
</header>

<div id="root" class="container"></div>

<script type="text/babel">

const API_URL = "https://credit-backend-yh78.onrender.com";

function App(){

const [form,setForm]=React.useState({
sales:"",pat:"",dep:"",stock:"",debtors:"",
creditors:"",loan_req:"",emi:"",undocumented:"",bounce:""
});

const [docType,setDocType]=React.useState("");
const [file,setFile]=React.useState(null);
const [docResult,setDocResult]=React.useState(null);
const [result,setResult]=React.useState(null);
const [cases,setCases]=React.useState([]);
const [loading,setLoading]=React.useState(false);

const labels={
sales:"Annual Sales",
pat:"Net Profit (PAT)",
dep:"Depreciation",
stock:"Inventory",
debtors:"Sundry Debtors",
creditors:"Sundry Creditors",
loan_req:"Loan Requested",
emi:"Existing EMI",
undocumented:"Undocumented Income",
bounce:"Cheque Bounces"
};

const formatCurrency=(num)=>"â‚¹"+Number(num).toLocaleString("en-IN");

const riskColor=(score)=>{
if(score>=80) return "green";
if(score>=60) return "orange";
return "red";
};

const handleChange=e=>setForm({...form,[e.target.name]:e.target.value});

const uploadDocument=async()=>{
if(!file||!docType){alert("Select document type and file");return;}
const formData=new FormData();
formData.append("file",file);
formData.append("doc_type",docType);

const res=await fetch(API_URL+"/parse-document",{method:"POST",body:formData});
const data=await res.json();
setDocResult(data);

// Auto-fill financial form if PL/BS
if(docType==="pl"){
setForm(f=>({...f,
sales:data.Sales||"",
pat:data.Net_Profit||"",
dep:data.Depreciation||""
}));
}
if(docType==="bs"){
setForm(f=>({...f,
stock:data.Inventory||"",
debtors:data.Debtors||"",
creditors:data.Creditors||""
}));
}
if(docType==="bank"){
setForm(f=>({...f,
bounce:data.Bounce_Count||""
}));
}
};

const handleSubmit=async()=>{
setLoading(true);
const res=await fetch(API_URL+"/analyze",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(Object.fromEntries(Object.entries(form).map(([k,v])=>[k,Number(v)])))
});
const data=await res.json();
setResult(data);
fetchCases();
setLoading(false);
};

const fetchCases=async()=>{
const res=await fetch(API_URL+"/cases");
const data=await res.json();
setCases(data);
};

React.useEffect(()=>{fetchCases();},[]);

return(
<div>

{/* DOCUMENT UPLOAD */}
<div className="card">
<h3>Document Upload Section</h3>

<select onChange={(e)=>setDocType(e.target.value)}>
<option value="">Select Document Type</option>
<option value="bank">Bank Statement</option>
<option value="bs">Balance Sheet</option>
<option value="pl">P&L Statement</option>
</select>

<br/><br/>

<input type="file" onChange={(e)=>setFile(e.target.files[0])} />

<br/><br/>

<button onClick={uploadDocument}>Parse Document</button>

{docResult && (
<div style={{marginTop:"15px"}}>
<h4>Parsed Result</h4>
<pre>{JSON.stringify(docResult,null,2)}</pre>
</div>
)}
</div>

{/* FINANCIAL INPUTS */}
<div className="card">
<h3>Financial Inputs</h3>
<div className="grid">
{Object.keys(form).map(key=>(
<div key={key}>
<label>{labels[key]}</label>
<input name={key} value={form[key]} onChange={handleChange}/>
</div>
))}
</div>
<br/>
<button onClick={handleSubmit}>Run Credit Analysis</button>
</div>

{loading && <div className="loading">Analyzing Financial Data...</div>}

{/* RESULTS */}
{result && (
<div className="card">
<h3>Credit Analysis Report</h3>

<p><b>Case ID:</b> {result.Case_ID}</p>
<p><b>Final Eligible Limit:</b> {formatCurrency(result.Final_Limit)}</p>
<p><b>Risk Score:</b> <span className={riskColor(result.Risk_Score)}>{result.Risk_Score}</span></p>
<p><b>Risk Grade:</b> {result.Risk_Grade}</p>
<p><b>Decision:</b> {result.Decision}</p>

<hr/>

<h4>Ratio Analysis</h4>
<p><b>Profit Margin:</b> {result.Profit_Margin}%</p>
<p><b>Current Ratio:</b> {result.Current_Ratio}</p>
<p><b>Working Capital Gap:</b> {formatCurrency(result.Working_Capital_Gap)}</p>

<hr/>

<h4>Banking Summary</h4>
<p><b>Banking Conduct:</b> {result.Banking_Health}</p>

<a href={API_URL+"/generate-cam/"+result.Case_ID} target="_blank">
<button style={{marginTop:"10px"}}>Download CAM Report</button>
</a>

</div>
)}

{/* CASE HISTORY */}
<div className="card">
<h3>Case History</h3>
<table>
<thead>
<tr>
<th>Date</th>
<th>Case ID</th>
<th>Final Limit</th>
<th>Risk</th>
<th>Decision</th>
</tr>
</thead>
<tbody>
{cases.map((c,index)=>(
<tr key={index}>
<td>{c.Created_At}</td>
<td>{c.Case_ID.substring(0,8)}</td>
<td>{formatCurrency(c.Final_Limit)}</td>
<td className={riskColor(c.Risk_Score)}>{c.Risk_Score}</td>
<td>{c.Decision}</td>
</tr>
))}
</tbody>
</table>
</div>

</div>
);
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>

</body>
</html>
