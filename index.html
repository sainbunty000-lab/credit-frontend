<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Enterprise OCR Underwriting Suite</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Segoe UI;background:#0b1629;color:white;}
header{background:#111f3a;padding:20px;text-align:center;font-size:20px;font-weight:bold;}
.container{padding:20px;max-width:1000px;margin:auto;}
.card{background:#16233d;padding:20px;border-radius:10px;margin-bottom:20px;}
button{background:#00bcd4;border:none;padding:10px 16px;border-radius:6px;color:white;font-weight:bold;cursor:pointer;margin-top:10px;}
.slide{display:none;}
.slide.active{display:block;}
.loader{border:4px solid #f3f3f3;border-top:4px solid #00bcd4;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:auto;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.heat-low{background:#4caf50;padding:6px;border-radius:4px;}
.heat-medium{background:#ff9800;padding:6px;border-radius:4px;}
.heat-high{background:#f44336;padding:6px;border-radius:4px;}
.progressbar{height:10px;background:#333;border-radius:6px;overflow:hidden;}
.progressfill{height:10px;background:#00bcd4;}
.flag{background:#f44336;padding:6px;margin-top:5px;border-radius:4px;}
</style>
</head>

<body>

<header>Enterprise OCR Underwriting Suite</header>

<div class="container">

<div class="slide active" id="slide1">
<div class="card">
<h3>Upload Documents</h3>
<input type="file" id="bs" accept=".pdf"><br><br>
<input type="file" id="pl" accept=".pdf"><br><br>
<input type="file" id="bank" accept=".pdf"><br><br>
<button onclick="runAnalysis()">Run Analysis</button>
</div>
</div>

<div class="slide" id="slide2">
<div class="card">
<h3>Processing...</h3>
<div class="loader"></div>
</div>
</div>

<div class="slide" id="slide3">
<div class="card">
<h3>Risk Dashboard</h3>
<div id="dashboard"></div>
<button onclick="downloadCAM()">Download CAM PDF</button>
<button onclick="location.reload()">New Case</button>
</div>
</div>

</div>

<script>
const API_URL = "https://credit-backend-production-f657.up.railway.app";
let currentData=null;

function showSlide(n){
document.querySelectorAll(".slide").forEach(s=>s.classList.remove("active"));
document.getElementById("slide"+n).classList.add("active");
}

async function runAnalysis(){

const bs=document.getElementById("bs").files[0];
const pl=document.getElementById("pl").files[0];
const bank=document.getElementById("bank").files[0];

if(!bank){alert("Bank statement is mandatory.");return;}
if(!bs && !pl){alert("Upload either Balance Sheet or P&L.");return;}

showSlide(2);

const fd=new FormData();
if(bs) fd.append("bs_file",bs);
if(pl) fd.append("pl_file",pl);
fd.append("bank_file",bank);

const res=await fetch(API_URL+"/analyze",{method:"POST",body:fd});
const data=await res.json();

if(data.error){alert(data.error);showSlide(1);return;}

currentData=data;
buildDashboard(data);
showSlide(3);
}

function buildDashboard(d){

let heatClass="heat-low";
if(d.Risk_Score<60) heatClass="heat-high";
else if(d.Risk_Score<75) heatClass="heat-medium";

let fraudFlags="";
if(d.Mismatch_%>25) fraudFlags+=`<div class="flag">High Turnover Mismatch</div>`;
if(d.Parsing_Confidence<80) fraudFlags+=`<div class="flag">Low OCR Confidence</div>`;
if(fraudFlags==="") fraudFlags="No major red flags.";

document.getElementById("dashboard").innerHTML=`
<b>Case ID:</b> ${d.Case_ID}<br><br>
<b>Sales:</b> ₹${d.Sales}<br>
<b>Bank Turnover:</b> ₹${d.Bank_Turnover}<br><br>
<b>Working Capital:</b> ₹${d.Working_Capital_Limit}<br>
<b>Agriculture Limit:</b> ₹${d.Agri_Limit}<br><br>
<div class="${heatClass}">Risk Score: ${d.Risk_Score}</div><br>
<b>Accuracy:</b>
<div class="progressbar">
<div class="progressfill" style="width:${d.Parsing_Confidence}%"></div>
</div>
${d.Parsing_Confidence}%<br><br>
<h4>Fraud Flags</h4>
${fraudFlags}<br>
<i>${d.AI_Explanation}</i>
`;
}

function downloadCAM(){
const {jsPDF}=window.jspdf;
const doc=new jsPDF();
doc.text("Credit Appraisal Memorandum",20,20);
doc.text(`Case ID: ${currentData.Case_ID}`,20,40);
doc.text(`Working Capital: ₹${currentData.Working_Capital_Limit}`,20,50);
doc.text(`Agriculture Limit: ₹${currentData.Agri_Limit}`,20,60);
doc.text(`Risk Score: ${currentData.Risk_Score}`,20,70);
doc.text(`Decision: ${currentData.Decision}`,20,80);
doc.save("CAM_Report.pdf");
}
</script>

</body>
</html>
